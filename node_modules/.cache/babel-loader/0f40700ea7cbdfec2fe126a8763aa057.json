{"remainingRequest":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\src\\common\\cache\\CachePoi.js","dependencies":[{"path":"D:\\cdRule\\src\\common\\cache\\CachePoi.js","mtime":1656146798223},{"path":"D:\\cdRule\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.set\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.set\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport { arrayToMap, arrayRemoveItem } from '@/common/util/Arrays.js';\nimport { arrayToTree } from '@/common/util/Trees.js';\nimport { objCopyTo } from '@/common/util/Objects.js';\nimport { getPoiIconUrl } from '@/common/util/Urls.js';\nimport PoiPopup from '@/modules/MgrPoiModule/PoiPopup.vue';\nvar CACHE = {\n  widgets: null,\n  list: null,\n  map: null,\n  root: null\n};\nvar loading = false;\nexport { CACHE };\nexport function getPois(callback) {\n  if (CACHE.list) {\n    return callback ? callback(CACHE) : CACHE;\n  }\n\n  if (callback && loading) {\n    //正在请求后台加载中，等1秒再试试\n    return setTimeout(function () {\n      return getPois(callback);\n    }, 1000);\n  }\n\n  loading = true;\n\n  var fun = function fun(result) {\n    loading = false;\n    CACHE.widgets = result[1] || [];\n    CACHE.list = result[0] || [];\n    CACHE.map = arrayToMap(CACHE.list, 'id');\n    CACHE.root = {\n      id: '0',\n      type: '0',\n      name: $_L.get('标注分类'),\n      all: 0,\n      my: 0,\n      _dir: false\n    };\n    arrayToTree(CACHE.list, \"id\", \"pid\", CACHE.map, CACHE.root);\n    countPoi();\n    return callback ? callback(CACHE) : CACHE;\n  };\n\n  return callback ? window.$_main.http.get('h5/mgr/poi?getByUserId').then(fun) : fun(window.$_main.http.syncGet('h5/mgr/poi?getByUserId'));\n}\n\nfunction countPoi() {\n  var dirs = {},\n      dir,\n      count;\n\n  for (var i = 0, len = CACHE.list.length, poi; i < len; i++) {\n    poi = CACHE.list[i];\n\n    if (poi.type == '0') {\n      poi.all = poi.my = 0;\n      continue;\n    }\n\n    count = dirs[poi.pid];\n    !count && (dirs[poi.pid] = count = {\n      all: 0,\n      my: 0\n    });\n    count.all++;\n    poi.auser == $_main.userId && count.my++; // poi.auser == $_cache.user.userId && count.my++;\n  }\n\n  for (var id in dirs) {\n    dir = CACHE.map[id];\n    count = dirs[id];\n\n    if (!dir) {\n      CACHE.root.all += count.all;\n      CACHE.root.my += count.my;\n    } else {\n      do {\n        dir.all += count.all;\n        dir.my += count.my;\n        dir = dir.parent;\n      } while (dir);\n    }\n  }\n}\n\nexport function getDirTree(callback) {\n  var fun = function fun() {\n    !CACHE.root._dir && setDirs(CACHE.root);\n    CACHE.root._dir = true;\n    return callback ? callback(CACHE) : CACHE;\n  };\n\n  return callback ? getPois(fun) : fun(getPois());\n}\n\nfunction setDirs(node) {\n  if (!node.children) return;\n\n  for (var i = 0, len = node.children.length, item; i < len; i++) {\n    item = node.children[i];\n    if (item.type != '0') continue;\n    node.dirs = node.dirs || [];\n    node.dirs.push(item);\n    setDirs(item);\n  }\n}\n\nvar TREES = {};\nexport function onPoiTreeAdd(treeId, tree) {\n  TREES[treeId] = tree;\n}\nexport function onPoiTreeRemove(treeId) {\n  delete TREES[treeId];\n}\nexport function getPoisByDirId(dirId, list, node) {\n  list = list || [];\n\n  if (dirId == '0') {\n    //root\n    for (var i = 0, len = CACHE.list.length, o; i < len; i++) {\n      o = CACHE.list[i];\n      o.type != '0' && list.push(o);\n    }\n  } else {\n    node = node || CACHE.map[dirId];\n\n    if (node.children) {\n      for (var _i = 0, _len = node.children.length, _o; _i < _len; _i++) {\n        _o = node.children[_i];\n        _o.type == '0' ? getPoisByDirId(_o.id, list, _o) : list.push(_o);\n      }\n    }\n  }\n\n  return list;\n}\nvar MAPS = [];\nexport function drawPoiToMap(map) {\n  var fitview = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n  getPois(function (C) {\n    var mks = [];\n    C.list.forEach(function (poi) {\n      return poi.type != '0' && mks.push(poiToMarker(poi));\n    });\n    map.setMarkers(mks, 'poi', fitview);\n    MAPS.indexOf(map) == -1 && MAPS.push(map);\n  });\n}\nexport function poiToMarker(poi) {\n  return {\n    id: 'poi_' + poi.id,\n    text: poi.name,\n    lnglat: poi,\n    icon: getPoiIconUrl(poi.icon),\n    popup: PoiPopup,\n    minZoom: poi.minZoom\n  };\n}\nexport function onPoiMapDestroy(map) {\n  var i = MAPS.indexOf(map);\n  i != -1 && MAPS.splice(i, 1);\n}\nexport function onAddOrUpdate(item) {\n  var old = CACHE.map[item.id],\n      parent = CACHE.map[item.pid] || CACHE.root;\n\n  if (!old) {\n    CACHE.map[item.id] = item;\n    CACHE.list.push(item);\n    addToTree(item, parent);\n  } else {\n    if (old.pid != item.pid) {\n      removeFromTree(old);\n      objCopyTo(item, old, new Set(['parent', 'children', 'dirs']));\n      addToTree(old, parent);\n    } else {\n      objCopyTo(item, old, new Set(['parent', 'children', 'dirs']));\n      updateTreeNode(old);\n    }\n\n    item = old;\n  }\n\n  if (item.type == '1') {\n    //poi同步地图\n    MAPS.forEach(function (map) {\n      return map.poi && map.setMarker(poiToMarker(item), 'poi', false);\n    });\n  }\n\n  return item;\n}\nexport function onDelete(item) {\n  item = CACHE.map[item.id] || item;\n  delete CACHE.map[item.id];\n  removeFromTree(item);\n  item.type == '1' && MAPS.forEach(function (map) {\n    return map.poi && map.removeMarker('poi_' + item.id, 'poi');\n  }); //poi同步地图\n}\n\nfunction removeFromTree(item) {\n  var parent = item.parent,\n      is_dir = item.type == '0',\n      set_dir = CACHE.root._dir; //删除parent.children\n\n  arrayRemoveItem(parent.children, item);\n  if (parent.children.length == 0) delete parent.children;\n\n  if (is_dir && set_dir) {\n    //删除parent.dirs\n    arrayRemoveItem(parent.dirs, item);\n    if (parent.dirs.length == 0) delete parent.dirs;\n  }\n\n  for (var treeId in TREES) {\n    //同步删除树\n    var tree = TREES[treeId];\n    if (is_dir || !tree.dir) tree.getTree().removeNode(item);\n  }\n\n  var count = is_dir ? item : {\n    all: 1,\n    my: item.auser == $_cache.user.userId ? 1 : 0\n  };\n  if (count.all <= 0) return;\n\n  while (item.parent) {\n    item = item.parent;\n    item.all -= count.all;\n    item.my -= count.my;\n\n    for (var _treeId in TREES) {\n      //同步更新树\n      var _tree = TREES[_treeId];\n\n      _tree.getTree().updateNodeName(item);\n    }\n  }\n}\n\nfunction addToTree(item, parent) {\n  var is_dir = item.type == '0',\n      set_dir = CACHE.root._dir;\n  item.parent = parent;\n  parent.children = parent.children || [];\n  parent.children.push(item);\n\n  if (is_dir && set_dir) {\n    parent.dirs = parent.dirs || [];\n    parent.dirs.push(item);\n  }\n\n  for (var treeId in TREES) {\n    //同步树\n    var tree = TREES[treeId];\n    if (is_dir || !tree.dir) tree.getTree().addNodes(parent, -1, item);\n  } //更新count\n\n\n  var count = is_dir ? item : {\n    all: 1,\n    my: item.auser == $_cache.user.userId ? 1 : 0\n  };\n  count.all = count.all || 0;\n  count.my = count.my || 0;\n  if (count.all <= 0) return;\n\n  while (item.parent) {\n    item = item.parent;\n    item.all += count.all;\n    item.my += count.my;\n\n    for (var _treeId2 in TREES) {\n      //同步更新树\n      var _tree2 = TREES[_treeId2];\n\n      _tree2.getTree().updateNodeName(item);\n    }\n  }\n}\n\nfunction updateTreeNode(item) {\n  var is_dir = item.type == '0';\n\n  for (var treeId in TREES) {\n    //同步树\n    var tree = TREES[treeId];\n    if (is_dir || !tree.dir) tree.getTree().updateNode(item);\n  }\n}",{"version":3,"sources":["D:\\cdRule\\src\\common\\cache\\CachePoi.js"],"names":["CACHE","widgets","list","map","root","loading","callback","setTimeout","getPois","fun","result","arrayToMap","id","type","name","$_L","all","my","_dir","arrayToTree","countPoi","window","dirs","i","len","poi","count","$_main","dir","setDirs","node","item","TREES","dirId","o","getPoisByDirId","MAPS","fitview","mks","C","poiToMarker","text","lnglat","icon","getPoiIconUrl","popup","minZoom","old","parent","addToTree","removeFromTree","objCopyTo","updateTreeNode","is_dir","set_dir","arrayRemoveItem","tree","$_cache"],"mappings":";;;;;;;;AAAA,SAAA,UAAA,EAAA,eAAA,QAAA,yBAAA;AACA,SAAA,WAAA,QAAA,wBAAA;AACA,SAAA,SAAA,QAAA,0BAAA;AACA,SAAA,aAAA,QAAA,uBAAA;AACA,OAAA,QAAA,MAAA,qCAAA;AAEA,IAAIA,KAAK,GAAG;AAACC,EAAAA,OAAO,EAAR,IAAA;AAAeC,EAAAA,IAAI,EAAnB,IAAA;AAA2BC,EAAAA,GAAG,EAA9B,IAAA;AAAsCC,EAAAA,IAAI,EAAE;AAA5C,CAAZ;AACA,IAAIC,OAAO,GAAX,KAAA;AAEA,SAAA,KAAA;AAEA,OAAO,SAAA,OAAA,CAAA,QAAA,EAA2B;AACjC,MAAIL,KAAK,CAAT,IAAA,EAAgB;AACf,WAAOM,QAAQ,GAAGA,QAAQ,CAAX,KAAW,CAAX,GAAf,KAAA;AACA;;AACD,MAAIA,QAAQ,IAAZ,OAAA,EAAyB;AAAC;AACxB,WAAOC,UAAU,CAAC,YAAA;AAAA,aAAIC,OAAO,CAAX,QAAW,CAAX;AAAD,KAAA,EAAjB,IAAiB,CAAjB;AACD;;AACDH,EAAAA,OAAO,GAAPA,IAAAA;;AACA,MAAII,GAAG,GAAG,SAANA,GAAM,CAAA,MAAA,EAAU;AACnBJ,IAAAA,OAAO,GAAPA,KAAAA;AACAL,IAAAA,KAAK,CAALA,OAAAA,GAAgBU,MAAM,CAANA,CAAM,CAANA,IAAhBV,EAAAA;AACAA,IAAAA,KAAK,CAALA,IAAAA,GAAaU,MAAM,CAANA,CAAM,CAANA,IAAbV,EAAAA;AACAA,IAAAA,KAAK,CAALA,GAAAA,GAAYW,UAAU,CAACX,KAAK,CAAN,IAAA,EAAtBA,IAAsB,CAAtBA;AACAA,IAAAA,KAAK,CAALA,IAAAA,GAAa;AAACY,MAAAA,EAAE,EAAH,GAAA;AAASC,MAAAA,IAAI,EAAb,GAAA;AAAmBC,MAAAA,IAAI,EAACC,GAAG,CAAHA,GAAAA,CAAxB,MAAwBA,CAAxB;AAAyCC,MAAAA,GAAG,EAA5C,CAAA;AAAgDC,MAAAA,EAAE,EAAlD,CAAA;AAAsDC,MAAAA,IAAI,EAAC;AAA3D,KAAblB;AACEmB,IAAAA,WAAW,CAACnB,KAAK,CAAN,IAAA,EAAA,IAAA,EAAA,KAAA,EAA0BA,KAAK,CAA/B,GAAA,EAAqCA,KAAK,CAArDmB,IAAW,CAAXA;AACFC,IAAAA,QAAQ;AACR,WAAOd,QAAQ,GAAGA,QAAQ,CAAX,KAAW,CAAX,GAAf,KAAA;AARD,GAAA;;AAUA,SAAOA,QAAQ,GAAGe,MAAM,CAANA,MAAAA,CAAAA,IAAAA,CAAAA,GAAAA,CAAAA,wBAAAA,EAAAA,IAAAA,CAAH,GAAGA,CAAH,GAAgEZ,GAAG,CAACY,MAAM,CAANA,MAAAA,CAAAA,IAAAA,CAAAA,OAAAA,CAAnF,wBAAmFA,CAAD,CAAlF;AACA;;AAED,SAAA,QAAA,GAAoB;AACnB,MAAIC,IAAI,GAAR,EAAA;AAAA,MAAA,GAAA;AAAA,MAAA,KAAA;;AACA,OAAK,IAAIC,CAAC,GAAL,CAAA,EAAQC,GAAG,GAACxB,KAAK,CAALA,IAAAA,CAAZ,MAAA,EAAL,GAAA,EAAwCuB,CAAC,GAAzC,GAAA,EAA+CA,CAA/C,EAAA,EAAoD;AACnDE,IAAAA,GAAG,GAAGzB,KAAK,CAALA,IAAAA,CAANyB,CAAMzB,CAANyB;;AACA,QAAIA,GAAG,CAAHA,IAAAA,IAAJ,GAAA,EAAqB;AACpBA,MAAAA,GAAG,CAAHA,GAAAA,GAAUA,GAAG,CAAHA,EAAAA,GAAVA,CAAAA;AACA;AACA;;AACDC,IAAAA,KAAK,GAAGJ,IAAI,CAACG,GAAG,CAAhBC,GAAY,CAAZA;AACA,KAAA,KAAA,KAAWJ,IAAI,CAACG,GAAG,CAARH,GAAI,CAAJA,GAAgBI,KAAK,GAAG;AAACV,MAAAA,GAAG,EAAJ,CAAA;AAAQC,MAAAA,EAAE,EAAC;AAAX,KAAnC;AACAS,IAAAA,KAAK,CAALA,GAAAA;AACAD,IAAAA,GAAG,CAAHA,KAAAA,IAAaE,MAAM,CAAnBF,MAAAA,IAA8BC,KAAK,CATgB,EASrBA,EAA9BD,CATmD,CAUnD;AACA;;AACD,OAAK,IAAL,EAAA,IAAA,IAAA,EAAqB;AACpBG,IAAAA,GAAG,GAAG5B,KAAK,CAALA,GAAAA,CAAN4B,EAAM5B,CAAN4B;AACAF,IAAAA,KAAK,GAAGJ,IAAI,CAAZI,EAAY,CAAZA;;AACA,QAAI,CAAJ,GAAA,EAAU;AACT1B,MAAAA,KAAK,CAALA,IAAAA,CAAAA,GAAAA,IAAkB0B,KAAK,CAAvB1B,GAAAA;AACAA,MAAAA,KAAK,CAALA,IAAAA,CAAAA,EAAAA,IAAiB0B,KAAK,CAAtB1B,EAAAA;AAFD,KAAA,MAGO;AACN,SAAG;AACF4B,QAAAA,GAAG,CAAHA,GAAAA,IAAWF,KAAK,CAAhBE,GAAAA;AACAA,QAAAA,GAAG,CAAHA,EAAAA,IAAUF,KAAK,CAAfE,EAAAA;AACAA,QAAAA,GAAG,GAAGA,GAAG,CAATA,MAAAA;AAHD,OAAA,QAAA,GAAA;AAKA;AACD;AACD;;AAED,OAAO,SAAA,UAAA,CAAA,QAAA,EAA8B;AACpC,MAAInB,GAAG,GAAG,SAANA,GAAM,GAAM;AACf,KAACT,KAAK,CAALA,IAAAA,CAAD,IAAA,IAAoB6B,OAAO,CAAC7B,KAAK,CAAjC,IAA2B,CAA3B;AACAA,IAAAA,KAAK,CAALA,IAAAA,CAAAA,IAAAA,GAAAA,IAAAA;AACA,WAAOM,QAAQ,GAAGA,QAAQ,CAAX,KAAW,CAAX,GAAf,KAAA;AAHD,GAAA;;AAKA,SAAOA,QAAQ,GAAGE,OAAO,CAAV,GAAU,CAAV,GAAkBC,GAAG,CAACD,OAArC,EAAoC,CAApC;AACA;;AAED,SAAA,OAAA,CAAA,IAAA,EAAuB;AACtB,MAAI,CAACsB,IAAI,CAAT,QAAA,EAAoB;;AACpB,OAAK,IAAIP,CAAC,GAAL,CAAA,EAAQC,GAAG,GAACM,IAAI,CAAJA,QAAAA,CAAZ,MAAA,EAAL,IAAA,EAA4CP,CAAC,GAA7C,GAAA,EAAmDA,CAAnD,EAAA,EAAwD;AACvDQ,IAAAA,IAAI,GAAGD,IAAI,CAAJA,QAAAA,CAAPC,CAAOD,CAAPC;AACA,QAAIA,IAAI,CAAJA,IAAAA,IAAJ,GAAA,EAAsB;AACtBD,IAAAA,IAAI,CAAJA,IAAAA,GAAYA,IAAI,CAAJA,IAAAA,IAAZA,EAAAA;AACAA,IAAAA,IAAI,CAAJA,IAAAA,CAAAA,IAAAA,CAAAA,IAAAA;AACAD,IAAAA,OAAO,CAAPA,IAAO,CAAPA;AACA;AACD;;AACD,IAAIG,KAAK,GAAT,EAAA;AACA,OAAO,SAAA,YAAA,CAAA,MAAA,EAAA,IAAA,EAAoC;AAC1CA,EAAAA,KAAK,CAALA,MAAK,CAALA,GAAAA,IAAAA;AACA;AACD,OAAO,SAAA,eAAA,CAAA,MAAA,EAAiC;AACvC,SAAOA,KAAK,CAAZ,MAAY,CAAZ;AACA;AAED,OAAO,SAAA,cAAA,CAAA,KAAA,EAAA,IAAA,EAAA,IAAA,EAA2C;AACjD9B,EAAAA,IAAI,GAAGA,IAAI,IAAXA,EAAAA;;AACA,MAAI+B,KAAK,IAAT,GAAA,EAAkB;AAAC;AAClB,SAAK,IAAIV,CAAC,GAAL,CAAA,EAAQC,GAAG,GAACxB,KAAK,CAALA,IAAAA,CAAZ,MAAA,EAAL,CAAA,EAAuCuB,CAAC,GAAxC,GAAA,EAA8CA,CAA9C,EAAA,EAAmD;AAClDW,MAAAA,CAAC,GAAGlC,KAAK,CAALA,IAAAA,CAAJkC,CAAIlC,CAAJkC;AACAA,MAAAA,CAAC,CAADA,IAAAA,IAAAA,GAAAA,IAAiBhC,IAAI,CAAJA,IAAAA,CAAjBgC,CAAiBhC,CAAjBgC;AACA;AAJF,GAAA,MAKO;AACNJ,IAAAA,IAAI,GAAGA,IAAI,IAAI9B,KAAK,CAALA,GAAAA,CAAf8B,KAAe9B,CAAf8B;;AACA,QAAIA,IAAI,CAAR,QAAA,EAAmB;AAClB,WAAK,IAAIP,EAAC,GAAL,CAAA,EAAQC,IAAG,GAACM,IAAI,CAAJA,QAAAA,CAAZ,MAAA,EAAL,EAAA,EAAyCP,EAAC,GAA1C,IAAA,EAAgDA,EAAhD,EAAA,EAAqD;AACpDW,QAAAA,EAAC,GAAGJ,IAAI,CAAJA,QAAAA,CAAJI,EAAIJ,CAAJI;AACAA,QAAAA,EAAC,CAADA,IAAAA,IAAAA,GAAAA,GAAgBC,cAAc,CAACD,EAAC,CAAF,EAAA,EAAA,IAAA,EAA9BA,EAA8B,CAA9BA,GAAgDhC,IAAI,CAAJA,IAAAA,CAAhDgC,EAAgDhC,CAAhDgC;AACA;AACD;AACD;;AACD,SAAA,IAAA;AACA;AAED,IAAIE,IAAI,GAAR,EAAA;AACA,OAAO,SAAA,YAAA,CAAA,GAAA,EAA0C;AAAA,MAAfC,OAAe,GAAA,SAAA,CAAA,MAAA,GAAA,CAAA,IAAA,SAAA,CAAA,CAAA,CAAA,KAAA,SAAA,GAAA,SAAA,CAAA,CAAA,CAAA,GAAP,KAAO;AAChD7B,EAAAA,OAAO,CAAC,UAAA,CAAA,EAAK;AACZ,QAAI8B,GAAG,GAAP,EAAA;AACAC,IAAAA,CAAC,CAADA,IAAAA,CAAAA,OAAAA,CAAe,UAAA,GAAA,EAAG;AAAA,aAAId,GAAG,CAAHA,IAAAA,IAAAA,GAAAA,IAAiBa,GAAG,CAAHA,IAAAA,CAASE,WAAW,CAAzC,GAAyC,CAApBF,CAArB;AAAlBC,KAAAA;AACApC,IAAAA,GAAG,CAAHA,UAAAA,CAAAA,GAAAA,EAAAA,KAAAA,EAAAA,OAAAA;AACAiC,IAAAA,IAAI,CAAJA,OAAAA,CAAAA,GAAAA,KAAqB,CAArBA,CAAAA,IAA2BA,IAAI,CAAJA,IAAAA,CAA3BA,GAA2BA,CAA3BA;AAJD5B,GAAO,CAAPA;AAMA;AAED,OAAO,SAAA,WAAA,CAAA,GAAA,EAA0B;AAChC,SAAO;AAACI,IAAAA,EAAE,EAAC,SAAOa,GAAG,CAAd,EAAA;AAAmBgB,IAAAA,IAAI,EAAChB,GAAG,CAA3B,IAAA;AAAkCiB,IAAAA,MAAM,EAAxC,GAAA;AAA8CC,IAAAA,IAAI,EAACC,aAAa,CAACnB,GAAG,CAApE,IAAgE,CAAhE;AAA4EoB,IAAAA,KAAK,EAAjF,QAAA;AAA4FC,IAAAA,OAAO,EAACrB,GAAG,CAACqB;AAAxG,GAAP;AACA;AAED,OAAO,SAAA,eAAA,CAAA,GAAA,EAA8B;AACpC,MAAIvB,CAAC,GAAGa,IAAI,CAAJA,OAAAA,CAAR,GAAQA,CAAR;AACAb,EAAAA,CAAC,IAAI,CAALA,CAAAA,IAAWa,IAAI,CAAJA,MAAAA,CAAAA,CAAAA,EAAXb,CAAWa,CAAXb;AACA;AAED,OAAO,SAAA,aAAA,CAAA,IAAA,EAA6B;AACnC,MAAIwB,GAAG,GAAG/C,KAAK,CAALA,GAAAA,CAAU+B,IAAI,CAAxB,EAAU/B,CAAV;AAAA,MAA8BgD,MAAM,GAAGhD,KAAK,CAALA,GAAAA,CAAU+B,IAAI,CAAd/B,GAAAA,KAAuBA,KAAK,CAAnE,IAAA;;AACA,MAAI,CAAJ,GAAA,EAAU;AACTA,IAAAA,KAAK,CAALA,GAAAA,CAAU+B,IAAI,CAAd/B,EAAAA,IAAAA,IAAAA;AACAA,IAAAA,KAAK,CAALA,IAAAA,CAAAA,IAAAA,CAAAA,IAAAA;AACAiD,IAAAA,SAAS,CAAA,IAAA,EAATA,MAAS,CAATA;AAHD,GAAA,MAIO;AACN,QAAIF,GAAG,CAAHA,GAAAA,IAAWhB,IAAI,CAAnB,GAAA,EAAyB;AACxBmB,MAAAA,cAAc,CAAdA,GAAc,CAAdA;AACAC,MAAAA,SAAS,CAAA,IAAA,EAAA,GAAA,EAAY,IAAA,GAAA,CAAQ,CAAA,QAAA,EAAA,UAAA,EAA7BA,MAA6B,CAAR,CAAZ,CAATA;AACAF,MAAAA,SAAS,CAAA,GAAA,EAATA,MAAS,CAATA;AAHD,KAAA,MAIO;AACNE,MAAAA,SAAS,CAAA,IAAA,EAAA,GAAA,EAAY,IAAA,GAAA,CAAQ,CAAA,QAAA,EAAA,UAAA,EAA7BA,MAA6B,CAAR,CAAZ,CAATA;AACAC,MAAAA,cAAc,CAAdA,GAAc,CAAdA;AACA;;AACDrB,IAAAA,IAAI,GAAJA,GAAAA;AACA;;AACD,MAAIA,IAAI,CAAJA,IAAAA,IAAJ,GAAA,EAAsB;AAAC;AACtBK,IAAAA,IAAI,CAAJA,OAAAA,CAAa,UAAA,GAAA,EAAG;AAAA,aAAIjC,GAAG,CAAHA,GAAAA,IAAWA,GAAG,CAAHA,SAAAA,CAAcqC,WAAW,CAAzBrC,IAAyB,CAAzBA,EAAAA,KAAAA,EAAf,KAAeA,CAAf;AAAhBiC,KAAAA;AACA;;AACD,SAAA,IAAA;AACA;AAED,OAAO,SAAA,QAAA,CAAA,IAAA,EAAwB;AAC9BL,EAAAA,IAAI,GAAG/B,KAAK,CAALA,GAAAA,CAAU+B,IAAI,CAAd/B,EAAAA,KAAP+B,IAAAA;AACA,SAAO/B,KAAK,CAALA,GAAAA,CAAU+B,IAAI,CAArB,EAAO/B,CAAP;AACAkD,EAAAA,cAAc,CAAdA,IAAc,CAAdA;AACAnB,EAAAA,IAAI,CAAJA,IAAAA,IAAAA,GAAAA,IAAoB,IAAI,CAAJ,OAAA,CAAa,UAAA,GAAA,EAAG;AAAA,WAAI5B,GAAG,CAAHA,GAAAA,IAAWA,GAAG,CAAHA,YAAAA,CAAiB,SAAO4B,IAAI,CAA5B5B,EAAAA,EAAf,KAAeA,CAAf;AAJN,GAIV,CAApB4B,CAJ8B,CAI8D;AAC5F;;AAED,SAAA,cAAA,CAAA,IAAA,EAA8B;AAC7B,MAAIiB,MAAM,GAAGjB,IAAI,CAAjB,MAAA;AAAA,MAA0BsB,MAAM,GAAGtB,IAAI,CAAJA,IAAAA,IAAnC,GAAA;AAAA,MAAqDuB,OAAO,GAAGtD,KAAK,CAALA,IAAAA,CADlC,IAC7B,CAD6B,CAG7B;;AACAuD,EAAAA,eAAe,CAACP,MAAM,CAAP,QAAA,EAAfO,IAAe,CAAfA;AACA,MAAIP,MAAM,CAANA,QAAAA,CAAAA,MAAAA,IAAJ,CAAA,EAAiC,OAAOA,MAAM,CAAb,QAAA;;AAEjC,MAAIK,MAAM,IAAV,OAAA,EAAuB;AAAC;AACvBE,IAAAA,eAAe,CAACP,MAAM,CAAP,IAAA,EAAfO,IAAe,CAAfA;AACA,QAAIP,MAAM,CAANA,IAAAA,CAAAA,MAAAA,IAAJ,CAAA,EAA6B,OAAOA,MAAM,CAAb,IAAA;AAC7B;;AAED,OAAK,IAAL,MAAA,IAAA,KAAA,EAA0B;AAAC;AAC1B,QAAIQ,IAAI,GAAGxB,KAAK,CAAhB,MAAgB,CAAhB;AACA,QAAIqB,MAAM,IAAI,CAACG,IAAI,CAAnB,GAAA,EAAyBA,IAAI,CAAJA,OAAAA,GAAAA,UAAAA,CAAAA,IAAAA;AACzB;;AAED,MAAI9B,KAAK,GAAG2B,MAAM,GAAA,IAAA,GAAU;AAACrC,IAAAA,GAAG,EAAJ,CAAA;AAAQC,IAAAA,EAAE,EAACc,IAAI,CAAJA,KAAAA,IAAc0B,OAAO,CAAPA,IAAAA,CAAd1B,MAAAA,GAAAA,CAAAA,GAAwC;AAAnD,GAA5B;AACA,MAAIL,KAAK,CAALA,GAAAA,IAAJ,CAAA,EAAoB;;AACpB,SAAOK,IAAI,CAAX,MAAA,EAAoB;AACnBA,IAAAA,IAAI,GAAGA,IAAI,CAAXA,MAAAA;AACAA,IAAAA,IAAI,CAAJA,GAAAA,IAAYL,KAAK,CAAjBK,GAAAA;AACAA,IAAAA,IAAI,CAAJA,EAAAA,IAAWL,KAAK,CAAhBK,EAAAA;;AACA,SAAK,IAAL,OAAA,IAAA,KAAA,EAA0B;AAAC;AAC1B,UAAIyB,KAAI,GAAGxB,KAAK,CAAhB,OAAgB,CAAhB;;AACAwB,MAAAA,KAAI,CAAJA,OAAAA,GAAAA,cAAAA,CAAAA,IAAAA;AACA;AACD;AACD;;AAED,SAAA,SAAA,CAAA,IAAA,EAAA,MAAA,EAAiC;AAChC,MAAIH,MAAM,GAAGtB,IAAI,CAAJA,IAAAA,IAAb,GAAA;AAAA,MAA+BuB,OAAO,GAAGtD,KAAK,CAALA,IAAAA,CAAzC,IAAA;AACA+B,EAAAA,IAAI,CAAJA,MAAAA,GAAAA,MAAAA;AACAiB,EAAAA,MAAM,CAANA,QAAAA,GAAkBA,MAAM,CAANA,QAAAA,IAAlBA,EAAAA;AACAA,EAAAA,MAAM,CAANA,QAAAA,CAAAA,IAAAA,CAAAA,IAAAA;;AACA,MAAIK,MAAM,IAAV,OAAA,EAAuB;AACtBL,IAAAA,MAAM,CAANA,IAAAA,GAAcA,MAAM,CAANA,IAAAA,IAAdA,EAAAA;AACAA,IAAAA,MAAM,CAANA,IAAAA,CAAAA,IAAAA,CAAAA,IAAAA;AACA;;AAED,OAAK,IAAL,MAAA,IAAA,KAAA,EAA0B;AAAC;AAC1B,QAAIQ,IAAI,GAAGxB,KAAK,CAAhB,MAAgB,CAAhB;AACA,QAAIqB,MAAM,IAAI,CAACG,IAAI,CAAnB,GAAA,EAAyBA,IAAI,CAAJA,OAAAA,GAAAA,QAAAA,CAAAA,MAAAA,EAAgC,CAAhCA,CAAAA,EAAAA,IAAAA;AAZM,GAAA,CAehC;;;AACA,MAAI9B,KAAK,GAAG2B,MAAM,GAAA,IAAA,GAAU;AAACrC,IAAAA,GAAG,EAAJ,CAAA;AAAQC,IAAAA,EAAE,EAACc,IAAI,CAAJA,KAAAA,IAAc0B,OAAO,CAAPA,IAAAA,CAAd1B,MAAAA,GAAAA,CAAAA,GAAwC;AAAnD,GAA5B;AACAL,EAAAA,KAAK,CAALA,GAAAA,GAAYA,KAAK,CAALA,GAAAA,IAAZA,CAAAA;AAA4BA,EAAAA,KAAK,CAALA,EAAAA,GAAWA,KAAK,CAALA,EAAAA,IAAXA,CAAAA;AAC5B,MAAIA,KAAK,CAALA,GAAAA,IAAJ,CAAA,EAAoB;;AACpB,SAAOK,IAAI,CAAX,MAAA,EAAoB;AACnBA,IAAAA,IAAI,GAAGA,IAAI,CAAXA,MAAAA;AACAA,IAAAA,IAAI,CAAJA,GAAAA,IAAYL,KAAK,CAAjBK,GAAAA;AACAA,IAAAA,IAAI,CAAJA,EAAAA,IAAWL,KAAK,CAAhBK,EAAAA;;AACA,SAAK,IAAL,QAAA,IAAA,KAAA,EAA0B;AAAC;AAC1B,UAAIyB,MAAI,GAAGxB,KAAK,CAAhB,QAAgB,CAAhB;;AACAwB,MAAAA,MAAI,CAAJA,OAAAA,GAAAA,cAAAA,CAAAA,IAAAA;AACA;AACD;AACD;;AAED,SAAA,cAAA,CAAA,IAAA,EAA8B;AAC7B,MAAIH,MAAM,GAAGtB,IAAI,CAAJA,IAAAA,IAAb,GAAA;;AACA,OAAK,IAAL,MAAA,IAAA,KAAA,EAA0B;AAAC;AAC1B,QAAIyB,IAAI,GAAGxB,KAAK,CAAhB,MAAgB,CAAhB;AACA,QAAIqB,MAAM,IAAI,CAACG,IAAI,CAAnB,GAAA,EAAyBA,IAAI,CAAJA,OAAAA,GAAAA,UAAAA,CAAAA,IAAAA;AACzB;AACD","sourcesContent":["import { arrayToMap, arrayRemoveItem } from '@/common/util/Arrays.js';\r\nimport { arrayToTree } from '@/common/util/Trees.js';\r\nimport { objCopyTo } from '@/common/util/Objects.js';\r\nimport { getPoiIconUrl } from '@/common/util/Urls.js';\r\nimport PoiPopup from '@/modules/MgrPoiModule/PoiPopup.vue';\r\n\r\nlet CACHE = {widgets:null, list: null, map: null, root: null};\r\nlet loading = false;\r\n\r\nexport { CACHE };\r\n\r\nexport function getPois(callback) {\r\n\tif (CACHE.list) {\r\n\t\treturn callback ? callback(CACHE) : CACHE;\r\n\t}\r\n\tif (callback && loading) {//正在请求后台加载中，等1秒再试试\r\n\t  return setTimeout(()=>getPois(callback), 1000);\r\n\t}\r\n\tloading = true;\r\n\tlet fun = result => {\r\n\t\tloading = false;\r\n\t\tCACHE.widgets = result[1] || [];\r\n\t\tCACHE.list = result[0] || [];\r\n\t\tCACHE.map = arrayToMap(CACHE.list, 'id');\r\n\t\tCACHE.root = {id:'0', type:'0', name:$_L.get('标注分类'), all:0, my:0, _dir:false};\r\n  \t\tarrayToTree(CACHE.list, \"id\", \"pid\", CACHE.map, CACHE.root);\r\n\t\tcountPoi();\r\n\t\treturn callback ? callback(CACHE) : CACHE;\r\n\t}\r\n\treturn callback ? window.$_main.http.get('h5/mgr/poi?getByUserId').then(fun) : fun(window.$_main.http.syncGet('h5/mgr/poi?getByUserId'));\r\n}\r\n\r\nfunction countPoi() {\r\n\tlet dirs = {}, dir, count;\r\n\tfor (let i=0,len=CACHE.list.length,poi; i<len; i++) {\r\n\t\tpoi = CACHE.list[i];\r\n\t\tif (poi.type == '0') {\r\n\t\t\tpoi.all = poi.my = 0;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\tcount = dirs[poi.pid];\r\n\t\t!count && (dirs[poi.pid] = count = {all:0, my:0});\r\n\t\tcount.all++;\r\n\t\tpoi.auser == $_main.userId && count.my++;\r\n\t\t// poi.auser == $_cache.user.userId && count.my++;\r\n\t}\r\n\tfor (let id in dirs) {\r\n\t\tdir = CACHE.map[id];\r\n\t\tcount = dirs[id];\r\n\t\tif (!dir) {\r\n\t\t\tCACHE.root.all += count.all;\r\n\t\t\tCACHE.root.my += count.my;\r\n\t\t} else {\r\n\t\t\tdo {\r\n\t\t\t\tdir.all += count.all;\r\n\t\t\t\tdir.my += count.my;\r\n\t\t\t\tdir = dir.parent;\r\n\t\t\t} while(dir);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function getDirTree(callback) {\r\n\tlet fun = () => {\r\n\t\t!CACHE.root._dir && setDirs(CACHE.root);\r\n\t\tCACHE.root._dir = true;\r\n\t\treturn callback ? callback(CACHE) : CACHE;\r\n\t};\r\n\treturn callback ? getPois(fun) : fun(getPois());\r\n}\r\n\r\nfunction setDirs(node) {\r\n\tif (!node.children) return;\r\n\tfor (let i=0,len=node.children.length,item; i<len; i++) {\r\n\t\titem = node.children[i];\r\n\t\tif (item.type != '0') continue;\r\n\t\tnode.dirs = node.dirs || [];\r\n\t\tnode.dirs.push(item);\r\n\t\tsetDirs(item);\r\n\t}\r\n}\r\nlet TREES = {};\r\nexport function onPoiTreeAdd(treeId, tree) {\r\n\tTREES[treeId] = tree;\r\n}\r\nexport function onPoiTreeRemove(treeId) {\r\n\tdelete TREES[treeId];\r\n}\r\n\r\nexport function getPoisByDirId(dirId, list, node) {\r\n\tlist = list || [];\r\n\tif (dirId == '0') {//root\r\n\t\tfor (let i=0,len=CACHE.list.length, o; i<len; i++) {\r\n\t\t\to = CACHE.list[i]\r\n\t\t\to.type != '0' && list.push(o);\r\n\t\t}\r\n\t} else {\r\n\t\tnode = node || CACHE.map[dirId];\r\n\t\tif (node.children) {\r\n\t\t\tfor (let i=0,len=node.children.length,o; i<len; i++) {\r\n\t\t\t\to = node.children[i];\r\n\t\t\t\to.type == '0' ? getPoisByDirId(o.id, list, o) : list.push(o);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn list;\r\n}\r\n\r\nlet MAPS = [];\r\nexport function drawPoiToMap(map, fitview=false) {\r\n\tgetPois(C => {\r\n\t\tlet mks = [];\r\n\t\tC.list.forEach(poi => poi.type!='0' && mks.push(poiToMarker(poi)));\r\n\t\tmap.setMarkers(mks, 'poi', fitview);\r\n\t\tMAPS.indexOf(map) == -1 && MAPS.push(map);\r\n\t});\r\n}\r\n\r\nexport function poiToMarker(poi) {\r\n\treturn {id:'poi_'+poi.id, text:poi.name, lnglat:poi, icon:getPoiIconUrl(poi.icon), popup:PoiPopup, minZoom:poi.minZoom};\r\n}\r\n\r\nexport function onPoiMapDestroy(map) {\r\n\tlet i = MAPS.indexOf(map);\r\n\ti != -1 && MAPS.splice(i, 1);\r\n}\r\n\r\nexport function onAddOrUpdate(item) {\r\n\tlet old = CACHE.map[item.id], parent = CACHE.map[item.pid] || CACHE.root;\r\n\tif (!old) {\r\n\t\tCACHE.map[item.id] = item;\r\n\t\tCACHE.list.push(item);\r\n\t\taddToTree(item, parent);\r\n\t} else {\r\n\t\tif (old.pid != item.pid) {\r\n\t\t\tremoveFromTree(old);\r\n\t\t\tobjCopyTo(item, old, new Set(['parent', 'children', 'dirs']));\r\n\t\t\taddToTree(old, parent);\r\n\t\t} else {\r\n\t\t\tobjCopyTo(item, old, new Set(['parent', 'children', 'dirs']));\r\n\t\t\tupdateTreeNode(old);\r\n\t\t}\r\n\t\titem = old;\r\n\t}\r\n\tif (item.type == '1') {//poi同步地图\r\n\t\tMAPS.forEach(map => map.poi && map.setMarker(poiToMarker(item), 'poi', false));\r\n\t}\r\n\treturn item;\r\n}\r\n\r\nexport function onDelete(item) {\r\n\titem = CACHE.map[item.id] || item;\r\n\tdelete CACHE.map[item.id];\r\n\tremoveFromTree(item);\r\n\titem.type == '1' && MAPS.forEach(map => map.poi && map.removeMarker('poi_'+item.id, 'poi'));//poi同步地图\r\n}\r\n\r\nfunction removeFromTree(item) {\r\n\tlet parent = item.parent, is_dir = item.type == '0', set_dir = CACHE.root._dir;\r\n\t\r\n\t//删除parent.children\r\n\tarrayRemoveItem(parent.children, item);\r\n\tif (parent.children.length == 0) delete parent.children;\r\n\t\r\n\tif (is_dir && set_dir) {//删除parent.dirs\r\n\t\tarrayRemoveItem(parent.dirs, item);\r\n\t\tif (parent.dirs.length == 0) delete parent.dirs;\r\n\t}\r\n\t\r\n\tfor (let treeId in TREES) {//同步删除树\r\n\t\tlet tree = TREES[treeId];\r\n\t\tif (is_dir || !tree.dir) tree.getTree().removeNode(item);\r\n\t}\r\n\r\n\tlet count = is_dir ? item : {all:1, my:item.auser == $_cache.user.userId ? 1 : 0};\r\n\tif (count.all <= 0) return;\r\n\twhile (item.parent) {\r\n\t\titem = item.parent;\r\n\t\titem.all -= count.all;\r\n\t\titem.my -= count.my;\r\n\t\tfor (let treeId in TREES) {//同步更新树\r\n\t\t\tlet tree = TREES[treeId];\r\n\t\t\ttree.getTree().updateNodeName(item);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction addToTree(item, parent) {\r\n\tlet is_dir = item.type == '0', set_dir = CACHE.root._dir;\r\n\titem.parent = parent;\r\n\tparent.children = parent.children || [];\r\n\tparent.children.push(item);\r\n\tif (is_dir && set_dir) {\r\n\t\tparent.dirs = parent.dirs || [];\r\n\t\tparent.dirs.push(item);\r\n\t}\r\n\t\r\n\tfor (let treeId in TREES) {//同步树\r\n\t\tlet tree = TREES[treeId];\r\n\t\tif (is_dir || !tree.dir) tree.getTree().addNodes(parent, -1, item);\r\n\t}\r\n\r\n\t//更新count\r\n\tlet count = is_dir ? item : {all:1, my:item.auser == $_cache.user.userId ? 1 : 0};\r\n\tcount.all = count.all || 0; count.my = count.my || 0;\r\n\tif (count.all <= 0) return;\r\n\twhile (item.parent) {\r\n\t\titem = item.parent;\r\n\t\titem.all += count.all;\r\n\t\titem.my += count.my;\r\n\t\tfor (let treeId in TREES) {//同步更新树\r\n\t\t\tlet tree = TREES[treeId];\r\n\t\t\ttree.getTree().updateNodeName(item);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction updateTreeNode(item) {\r\n\tlet is_dir = item.type == '0';\r\n\tfor (let treeId in TREES) {//同步树\r\n\t\tlet tree = TREES[treeId];\r\n\t\tif (is_dir || !tree.dir) tree.getTree().updateNode(item);\r\n\t}\r\n}"]}]}