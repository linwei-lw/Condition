{"remainingRequest":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\src\\common\\util\\Exps.js","dependencies":[{"path":"D:\\cdRule\\src\\common\\util\\Exps.js","mtime":1612227987770},{"path":"D:\\cdRule\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/web.dom.iterable\";\nimport { UtilTools } from '@/components/Table/tools';\n/**\r\n * @param {Button} btn 导出按钮\r\n * @param {vxe-table/vxe-grid} table 数据表格\r\n * @param {String} fileName 保存的文件名称\r\n * @param {String} [title] 文件里面的标题，如果为空，取fileName值\r\n * @param {Array} [datas] 导出的数据，如果为空，取table的数据\r\n * \r\n * 例子：\r\n * <Button ref=\"btn\" icon=\"el-icon-download\" @click=\"exportToExcel($refs.btn, $refs.table, '轨迹报表明细')\"/>\r\n * <vxe-table ref=\"table\" ...>\r\n * \t<vxe-table-column ...\r\n * </vxe-table>\r\n */\n\nexport function exportToExcel(btn, table, fileName) {\n  var datas = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;\n  table = table.$refs.xTable || table;\n\n  if (datas && !Array.isArray(datas)) {\n    if (!datas.get) {\n      datas = detailExport(datas);\n    } else {\n      return asynDetailExport(table, fileName, datas);\n    }\n  }\n\n  datas = datas || table.afterFullData || table.getTableData().visibleData;\n\n  if (!datas || datas.length == 0) {\n    return $_alert.warn('无数据可导出！');\n  }\n\n  var columns = table.getTableColumn().fullColumn; //{collectColumn, fullColumn, visibleColumn, tableColumn}\n\n  var _columns = [],\n      _headers = [],\n      _aligns = [];\n  columns.forEach(function (column) {\n    if (!column.visible || !column.title || column.type == 'checkbox') return;\n\n    if (column.property || column.formatter || column.type == 'index') {\n      _columns.push(column);\n\n      _headers.push(column.title);\n\n      _aligns.push(column.align || 'center');\n    }\n  });\n  var uid = window.$_uuid(window.$_main.sessionId + \"_\");\n  server(uid, btn, table, datas, _columns, _headers, _aligns, fileName);\n}\n\nfunction asynDetailExport(table, fileName, _ref) {\n  var datas = _ref.datas,\n      end = _ref.end,\n      get = _ref.get;\n\n  if (!datas || datas.length == 0) {\n    $_alert.warn('无数据可导出！');\n    return null;\n  }\n\n  var columns = table.getTableColumn().fullColumn; //{collectColumn, fullColumn, visibleColumn, tableColumn}\n\n  var _columns = [],\n      _headers = [],\n      _aligns = [];\n  columns.forEach(function (column) {\n    if (!column.visible || !column.title || column.type == 'checkbox') return;\n\n    if (column.property || column.formatter || column.type == 'index') {\n      _columns.push(column);\n\n      _headers.push(column.title);\n\n      _aligns.push(column.align || 'center');\n    }\n  });\n  var info = {\n    ing: true,\n    hasData: false,\n    params: {\n      uid: window.$_uuid(window.$_main.sessionId + \"_\"),\n      file: fileName,\n      title: fileName,\n      headers: JSON.stringify(_headers),\n      aligns: JSON.stringify(_aligns)\n    }\n  };\n  dgDetailExport(table, datas, end, get, _columns, info, 0);\n  return info.ing ? {\n    cancel: function cancel() {\n      info.ing = false;\n      end();\n    }\n  } : null;\n}\n\nfunction dgDetailExport(table, datas, end, get, columns, info, index) {\n  if (index == datas.length) {\n    info.ing = false;\n    end();\n    return info.hasData ? download(window.$_main.domain.WEB_PATH + 'excel', info.params) : $_alert.warn('无数据可导出！');\n  }\n\n  get(datas[index], index + ' / ' + datas.length, function (details) {\n    if (!info.ing) return;\n\n    if (!details || details.length == 0) {\n      return dgDetailExport(table, datas, end, get, columns, info, ++index);\n    } else {\n      info.hasData = true;\n      details = next1000(table, details, columns, 0, 99999999);\n      details.push(null); //导出时加空行\n\n      window.$_main.http.post('h5/exp?append', {\n        uid: info.params.uid,\n        datas: details\n      }).then(function () {\n        dgDetailExport(table, datas, end, get, columns, info, ++index);\n      }).catch(end);\n    }\n  });\n}\n\nfunction detailExport(_ref2) {\n  var datas = _ref2.datas,\n      field = _ref2.field;\n  if (!datas || datas.length == 0) return [];\n  var details = [];\n\n  for (var i = 0, len = datas.length, array; i < len; i++) {\n    array = datas[i][field];\n    if (!array || array.length == 0) continue;\n\n    for (var j = 0, l = array.length; j < l; j++) {\n      details.push(array[j]);\n    }\n\n    details.push(null); //导出时加空行\n  }\n\n  return details;\n}\n\nfunction server(uid, btn, table, datas, columns, headers, aligns, fileName) {\n  var index = arguments.length > 8 && arguments[8] !== undefined ? arguments[8] : 0;\n\n  if (index < datas.length) {\n    index == 0 && setBtn(btn, true);\n\n    var _datas = next1000(table, datas, columns, index);\n\n    index += _datas.length;\n    return window.$_main.http.post('h5/exp?append', {\n      uid: uid,\n      datas: _datas\n    }).then(function () {\n      server(uid, btn, table, datas, columns, headers, aligns, fileName, index);\n    }).catch(function () {\n      setBtn(btn, false);\n    });\n  }\n\n  var params = {\n    uid: uid,\n    file: fileName,\n    title: fileName,\n    headers: JSON.stringify(headers),\n    aligns: JSON.stringify(aligns)\n  };\n  download(window.$_main.domain.WEB_PATH + 'excel', params);\n  setBtn(btn, false);\n}\n\nexport function download(url, params) {\n  var form = document.createElement(\"form\");\n  form.style.display = 'none';\n  form.action = url;\n  form.method = \"post\";\n\n  for (var key in params) {\n    var input = document.createElement(\"input\");\n    input.type = \"hidden\";\n    input.name = key;\n    input.value = params[key];\n    form.appendChild(input);\n  }\n\n  document.body.appendChild(form);\n  form.submit();\n  document.body.removeChild(form);\n}\n\nfunction setBtn(btn, loading) {\n  if (!btn || !btn.setIcon && !btn.setDisabled) return;\n\n  if (loading) {\n    btn.__icon = btn.icon;\n    btn.setIcon && btn.setIcon('el-icon-loading');\n    btn.setDisabled && btn.setDisabled(true);\n  } else {\n    btn.setIcon && btn.setIcon(btn.__icon);\n    delete btn.__icon;\n    btn.setDisabled && btn.setDisabled(false);\n  }\n}\n\nfunction next1000(table, datas, columns, index) {\n  var count = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : 1000;\n  var item = null,\n      text = null,\n      _datas = [],\n      params = {\n    $table: table\n  },\n      iii = '序号';\n\n  var _loop = function _loop(i, len) {\n    item = datas[i];\n    var texts = [];\n    params.row = item;\n    columns.forEach(function (column) {\n      if (!item) {\n        text = '';\n      } else if (column.title == iii) {\n        text = String(i + 1);\n      } else {\n        params.column = column;\n        text = UtilTools.getCellLabel(item, column, params);\n        text = text == null || text == undefined ? '' : String(text);\n        text = !text ? ' ' : text.replace('null', '');\n      }\n\n      texts.push(text);\n    });\n\n    _datas.push(texts);\n  };\n\n  for (var i = index, len = Math.min(datas.length, index + count); i < len; i++) {\n    _loop(i, len);\n  }\n\n  return _datas;\n}",{"version":3,"sources":["D:\\cdRule\\src\\common\\util\\Exps.js"],"names":["datas","table","Array","detailExport","asynDetailExport","$_alert","columns","_columns","_headers","_aligns","column","uid","window","server","end","get","info","ing","hasData","params","file","title","headers","JSON","aligns","dgDetailExport","cancel","index","download","details","next1000","field","i","len","array","j","l","setBtn","_datas","form","document","input","btn","count","item","text","$table","iii","Math","texts","String","UtilTools"],"mappings":"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","sourcesContent":["\r\nimport { UtilTools } from '@/components/Table/tools';\r\n\r\n/**\r\n * @param {Button} btn 导出按钮\r\n * @param {vxe-table/vxe-grid} table 数据表格\r\n * @param {String} fileName 保存的文件名称\r\n * @param {String} [title] 文件里面的标题，如果为空，取fileName值\r\n * @param {Array} [datas] 导出的数据，如果为空，取table的数据\r\n * \r\n * 例子：\r\n * <Button ref=\"btn\" icon=\"el-icon-download\" @click=\"exportToExcel($refs.btn, $refs.table, '轨迹报表明细')\"/>\r\n * <vxe-table ref=\"table\" ...>\r\n * \t<vxe-table-column ...\r\n * </vxe-table>\r\n */\r\nexport function exportToExcel(btn, table, fileName, datas=null) {\r\n\ttable = table.$refs.xTable || table;\r\n\tif (datas && !Array.isArray(datas)) {\r\n\t\tif (!datas.get) {\r\n\t\t\tdatas = detailExport(datas);\r\n\t\t} else {\r\n\t\t\treturn asynDetailExport(table, fileName, datas);\r\n\t\t}\r\n\t}\r\n\tdatas = datas || table.afterFullData || table.getTableData().visibleData;\r\n\tif (!datas || datas.length == 0) {\r\n\t\treturn $_alert.warn('无数据可导出！');\r\n\t}\r\n\tlet columns = table.getTableColumn().fullColumn;//{collectColumn, fullColumn, visibleColumn, tableColumn}\r\n\tlet _columns = [], _headers = [], _aligns = [];\r\n\tcolumns.forEach(column => {\r\n\t\tif (!column.visible || !column.title || column.type=='checkbox') return;\r\n\t\tif (column.property || column.formatter || column.type =='index') {\r\n\t\t\t_columns.push(column);\r\n\t\t\t_headers.push(column.title);\r\n\t\t\t_aligns.push(column.align||'center');\r\n\t\t}\r\n\t});\r\n\t\r\n\tlet uid = window.$_uuid(window.$_main.sessionId + \"_\");\r\n\tserver(uid, btn, table, datas, _columns, _headers, _aligns, fileName);\r\n}\r\n\r\nfunction asynDetailExport(table, fileName, {datas, end, get}) {\r\n\tif (!datas || datas.length == 0) {\r\n\t\t$_alert.warn('无数据可导出！');\r\n\t\treturn null;\r\n\t}\r\n\tlet columns = table.getTableColumn().fullColumn;//{collectColumn, fullColumn, visibleColumn, tableColumn}\r\n\tlet _columns = [], _headers = [], _aligns = [];\r\n\tcolumns.forEach(column => {\r\n\t\tif (!column.visible || !column.title || column.type=='checkbox') return;\r\n\t\tif (column.property || column.formatter || column.type =='index') {\r\n\t\t\t_columns.push(column);\r\n\t\t\t_headers.push(column.title);\r\n\t\t\t_aligns.push(column.align||'center');\r\n\t\t}\r\n\t});\r\n\tlet info = {ing: true, hasData: false, params: {uid: window.$_uuid(window.$_main.sessionId + \"_\"), file:fileName, title:fileName, headers:JSON.stringify(_headers), aligns:JSON.stringify(_aligns)}};\r\n\tdgDetailExport(table, datas, end, get, _columns, info, 0);\r\n\treturn info.ing ? {cancel: ()=> {info.ing = false; end();}} : null;\r\n}\r\n\r\nfunction dgDetailExport(table, datas, end, get, columns, info, index) {\r\n\tif (index == datas.length) {\r\n\t\tinfo.ing = false;\r\n\t\tend();\r\n\t\treturn info.hasData ? download(window.$_main.domain.WEB_PATH + 'excel', info.params) : $_alert.warn('无数据可导出！');\r\n\t}\r\n\tget(datas[index], index + ' / ' + datas.length, details => {\r\n\t\tif (!info.ing) return;\r\n\t\tif (!details || details.length == 0) {\r\n\t\t\treturn dgDetailExport(table, datas, end, get, columns, info, ++index);\r\n\t\t} else {\r\n\t\t\tinfo.hasData = true;\r\n\t\t\tdetails = next1000(table, details, columns, 0, 99999999);\r\n\t\t\tdetails.push(null);//导出时加空行\r\n\t\t\twindow.$_main.http.post('h5/exp?append', {uid:info.params.uid, datas:details}).then(()=>{\r\n\t\t\t\tdgDetailExport(table, datas, end, get, columns, info, ++index);\r\n\t\t\t}).catch(end);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction detailExport({datas, field}) {\r\n\tif (!datas || datas.length == 0) return [];\r\n\tlet details = [];\r\n\tfor (let i=0, len=datas.length, array; i<len; i++) {\r\n\t  array = datas[i][field];\r\n\t  if (!array || array.length == 0) continue;\r\n\t  for (let j=0, l=array.length; j<l; j++) {\r\n\t\tdetails.push(array[j]);\r\n\t  }\r\n\t  details.push(null);//导出时加空行\r\n\t}\r\n\treturn details;\r\n}\r\n  \r\nfunction server(uid, btn, table, datas, columns, headers, aligns, fileName, index=0) {\r\n\tif (index < datas.length) {\r\n\t\tindex == 0 && setBtn(btn, true);\r\n\t\tlet _datas = next1000(table, datas, columns, index);\r\n\t\tindex += _datas.length;\r\n\t\treturn window.$_main.http.post('h5/exp?append', {uid:uid, datas:_datas}).then(()=>{\r\n\t\t\tserver(uid, btn, table, datas, columns, headers, aligns, fileName, index);\r\n\t\t}).catch(()=>{\r\n\t\t\tsetBtn(btn, false);\r\n\t\t});\r\n\t}\r\n\t\r\n\tlet params = {uid:uid, file:fileName, title:fileName, headers:JSON.stringify(headers), aligns:JSON.stringify(aligns)};\r\n\tdownload(window.$_main.domain.WEB_PATH + 'excel', params);\r\n\t\r\n\tsetBtn(btn, false);\r\n}\r\n\r\nexport function download(url, params) {\r\n    let form = document.createElement(\"form\");\r\n    form.style.display = 'none';\r\n    form.action = url;\r\n    form.method = \"post\";\r\n    for (let key in params){\r\n      var input = document.createElement(\"input\");\r\n      input.type = \"hidden\";\r\n      input.name = key;\r\n      input.value = params[key];\r\n      form.appendChild(input);\r\n    }\r\n    document.body.appendChild(form);\r\n    form.submit();\r\n\tdocument.body.removeChild(form);\r\n}\r\n\r\nfunction setBtn(btn, loading) {\r\n\tif (!btn || (!btn.setIcon && !btn.setDisabled)) return;\r\n\tif (loading) {\r\n\t\tbtn.__icon = btn.icon;\r\n\t\tbtn.setIcon && btn.setIcon('el-icon-loading');\r\n\t\tbtn.setDisabled && btn.setDisabled(true);\r\n\t} else {\r\n\t\tbtn.setIcon && btn.setIcon(btn.__icon);\r\n\t\tdelete btn.__icon;\r\n\t\tbtn.setDisabled && btn.setDisabled(false);\r\n\t}\r\n}\r\n\r\nfunction next1000(table, datas, columns, index, count=1000) {\r\n\tlet item = null, text = null, _datas = [], params = {$table: table}, iii = '序号';\r\n\tfor (let i=index, len=Math.min(datas.length,index+count); i < len; i++) {\r\n\t\titem = datas[i];\r\n\t\tlet texts = [];\r\n\t\tparams.row = item;\r\n\t\tcolumns.forEach(column => {\r\n\t\t\tif (!item) {\r\n\t\t\t\ttext = '';\r\n\t\t\t} else if (column.title == iii) {\r\n\t\t\t\ttext = String(i+1);\r\n\t\t\t} else {\r\n\t\t\t\tparams.column = column;\r\n\t\t\t\ttext = UtilTools.getCellLabel(item, column, params);\r\n\t\t\t\ttext = (text == null || text == undefined) ? '' : String(text);\r\n\t\t\t\ttext = !text ? ' ' : text.replace('null','');\r\n\t\t\t}\r\n\t\t\ttexts.push(text);\r\n\t\t});\r\n\t\t_datas.push(texts);\r\n\t}\r\n\treturn _datas;\r\n}"]}]}