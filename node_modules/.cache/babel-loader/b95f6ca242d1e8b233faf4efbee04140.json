{"remainingRequest":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js!D:\\cdRule\\src\\common\\cache\\CacheTmn.js","dependencies":[{"path":"D:\\cdRule\\src\\common\\cache\\CacheTmn.js","mtime":1677657197199},{"path":"D:\\cdRule\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\cdRule\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _toConsumableArray from \"D:\\\\cdRule\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/toConsumableArray\";\nimport { arrayToMap, arrayRemoveValue } from '@/common/util/Arrays.js';\nimport { objCopyTo } from '@/common/util/Objects.js';\nimport { getCarById } from \"./CacheTeamCar.js\";\nimport { getTeams } from \"./CacheTeamCar.js\";\nimport { treeToMap } from '@/common/util/Trees.js';\nvar CACHE = {\n  list: null,\n  map: null\n};\nvar loading = false;\nexport function getTmns(callback) {\n  var refresh = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n  if (!refresh && CACHE.list) {\n    return callback ? callback(CACHE) : CACHE;\n  }\n\n  if (callback && loading) {\n    //正在请求后台加载中，等1秒再试试\n    return setTimeout(function () {\n      return getTmns(callback, refresh);\n    }, 1000);\n  }\n\n  loading = true;\n\n  var fun = function fun(result) {\n    loading = false;\n    initTmns(result);\n    return callback ? callback(CACHE) : CACHE;\n  };\n\n  return callback ? window.$_main.http.get('/mgr/tmn?getTmnList').then(fun) : fun(window.$_main.http.syncGet('/mgr/tmn?getTmnList'));\n}\nexport function initTmns(result) {\n  CACHE.list = result || [];\n  CACHE.map = arrayToMap(CACHE.list, 'id');\n}\nexport function getTmnsByTeamId(teamId) {\n  !CACHE.list && getTmns();\n\n  if (teamId == '0') {\n    return _toConsumableArray(CACHE.list);\n  }\n\n  var team = getTeams().map[teamId];\n  if (!team) return [];\n  var teams = treeToMap([team], 'id', 'teams'),\n      tmns = [];\n\n  for (var i = 0, len = CACHE.list.length, tmn; i < len; i++) {\n    tmn = CACHE.list[i];\n    teams[tmn.teamId] && tmns.push(tmn);\n  }\n\n  return tmns;\n}\nexport function getNotUsedTmns(teamId, carId) {\n  !CACHE.list && getTmns();\n  var tmns = [];\n\n  for (var i = 0, len = CACHE.list.length, tmn; i < len; i++) {\n    tmn = CACHE.list[i];\n\n    if (!tmn.carId && tmn.teamId == teamId) {\n      tmns.push(tmn);\n    } else if (tmn.carId && tmn.carId == carId) {\n      tmns.push(tmn);\n    }\n  }\n\n  return tmns;\n}\nexport function getTmnByKey(tmnKey) {\n  if (!tmnKey) return null;\n  !CACHE.list && getTmns();\n\n  for (var i = 0, len = CACHE.list.length, tmn; i < len; i++) {\n    tmn = CACHE.list[i];\n\n    if (tmn.tmnKey == tmnKey) {\n      return tmn;\n    }\n  }\n\n  return null;\n}\nexport function getTmnById(id) {\n  if (!id) return null;\n  !CACHE.list && getTmns();\n  return CACHE.map[id];\n}\nexport function onTmnAddOrUpdate(tmn) {\n  if (!CACHE.map || !tmn) return;\n  var old = CACHE.map[tmn.id];\n\n  if (!old) {\n    CACHE.map[tmn.id] = tmn;\n    CACHE.list.push(tmn);\n  } else {\n    var oldTmnKey = old.tmnKey;\n    objCopyTo(tmn, old); //终端标识发生变化，更新到关联的车辆上\n\n    if (oldTmnKey == tmn.tmnKey || !tmn.carId) return;\n    var car = getCarById(tmn.carId);\n    if (!car) return;\n\n    if (car.tmnId == tmn.id) {\n      //车辆主终端\n      car.tmnKey = tmn.tmnKey;\n    } else if (car.viceKeys) {\n      //车辆副终端  key1_v/a,key2_v/a,...\n      var keys = [];\n      car.viceKeys.split(',').forEach(function (key) {\n        return key.indexOf(oldTmnKey + '_') == 0 && keys.push(tmn.tmnKey + '_' + key.split('_')[1]);\n      });\n      car.viceKeys = keys.length ? keys.join(',') : null;\n    }\n  }\n}\nexport function onTmnDelete(tmnId) {\n  if (!CACHE.list || !tmnId) return;\n  var tmn = CACHE.map[tmnId];\n  delete CACHE.map[tmnId];\n  arrayRemoveValue(CACHE.list, 'id', tmnId); //解绑关联的车辆\n\n  if (!tmn || !tmn.carId) return;\n  var car = getCarById(tmn.carId);\n  if (!car) return;\n\n  if (car.tmnId == tmnId) {\n    //解绑车辆主终端\n    car.tmnId = car.tmnKey = null;\n  } else if (car.viceKeys) {\n    //解绑车辆副终端  key1_v/a,key2_v/a,...\n    var keys = [];\n    car.viceKeys.split(',').forEach(function (key) {\n      return key.indexOf(tmn.tmnKey + '_') != 0 && keys.push(key);\n    });\n    car.viceKeys = keys.length ? keys.join(',') : null;\n  }\n}\nexport function onTmnCarRecycle(car) {\n  if (!CACHE.map || !car) return;\n\n  if (car.tmnId) {\n    var tmn = CACHE.map[car.tmnId];\n    tmn && (tmn.carId = null);\n  }\n\n  if (car.viceKeys) {\n    car.viceKeys.split(',').forEach(function (key) {\n      var tmn = getTmnByKey(key.split('_')[0]);\n      tmn && (tmn.carId = null);\n    });\n  }\n}\nexport function onTmnUnbindCar(tmnIds) {\n  if (!CACHE.map || !tmnIds || tmnIds.length == 0) return;\n  tmnIds.forEach(function (tmnId) {\n    var tmn = tmnId ? CACHE.map[tmnId] : null;\n    tmn && (tmn.carId = null);\n  });\n}",{"version":3,"sources":["D:\\cdRule\\src\\common\\cache\\CacheTmn.js"],"names":["CACHE","list","map","loading","refresh","callback","setTimeout","getTmns","fun","initTmns","window","result","arrayToMap","teamId","team","getTeams","teams","treeToMap","tmns","i","len","tmn","old","oldTmnKey","objCopyTo","car","getCarById","keys","key","arrayRemoveValue","getTmnByKey","tmnIds","tmnId"],"mappings":"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","sourcesContent":["import { arrayToMap, arrayRemoveValue } from '@/common/util/Arrays.js';\r\nimport { objCopyTo } from '@/common/util/Objects.js';\r\nimport { getCarById } from './CacheTeamCar.js';\r\nimport { getTeams } from './CacheTeamCar.js';\r\nimport { treeToMap } from '@/common/util/Trees.js';\r\n\r\nlet CACHE = {list: null, map: null};\r\nlet loading = false;\r\n\r\nexport function getTmns(callback, refresh=false) {\r\n\tif (!refresh && CACHE.list) {\r\n\t\treturn callback ? callback(CACHE) : CACHE;\r\n\t}\r\n\tif (callback && loading) {//正在请求后台加载中，等1秒再试试\r\n\t  return setTimeout(()=>getTmns(callback,refresh), 1000);\r\n\t}\r\n\tloading = true;\r\n\tlet fun = result => {\r\n\t\tloading = false;\r\n\t\tinitTmns(result);\r\n\t\treturn callback ? callback(CACHE) : CACHE;\r\n\t}\r\n\treturn callback ? window.$_main.http.get('/mgr/tmn?getTmnList').then(fun) : fun(window.$_main.http.syncGet('/mgr/tmn?getTmnList'));\r\n}\r\n\r\nexport function initTmns(result) {\r\n\tCACHE.list = result || [];\r\n\tCACHE.map = arrayToMap(CACHE.list, 'id');\r\n}\r\n\r\nexport function getTmnsByTeamId(teamId) {\r\n\t!CACHE.list && getTmns();\r\n\tif (teamId == '0') {\r\n\t\treturn [...CACHE.list];\r\n\t}\r\n\tlet team = getTeams().map[teamId];\r\n\tif (!team) return [];\r\n\tlet teams = treeToMap([team],'id','teams'), tmns = [];\r\n\tfor (let i=0, len=CACHE.list.length, tmn; i<len; i++) {\r\n\t\ttmn = CACHE.list[i];\r\n\t\tteams[tmn.teamId] && tmns.push(tmn);\r\n\t}\r\n\treturn tmns;\r\n}\r\n\r\nexport function getNotUsedTmns(teamId, carId) {\r\n\t!CACHE.list && getTmns();\r\n\tlet tmns = [];\r\n\tfor (let i=0, len=CACHE.list.length, tmn; i<len; i++) {\r\n\t\ttmn = CACHE.list[i];\r\n\t\tif (!tmn.carId && tmn.teamId == teamId) {\r\n\t\t\ttmns.push(tmn);\r\n\t\t} else if (tmn.carId && tmn.carId == carId) {\r\n\t\t\ttmns.push(tmn);\r\n\t\t}\r\n\t}\r\n\treturn tmns;\r\n}\r\n\r\nexport function getTmnByKey(tmnKey) {\r\n\tif (!tmnKey) return null;\r\n\t!CACHE.list && getTmns();\r\n\tfor (let i=0, len=CACHE.list.length, tmn; i<len; i++) {\r\n\t\ttmn = CACHE.list[i];\r\n\t\tif (tmn.tmnKey == tmnKey) {\r\n\t\t\treturn tmn;\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nexport function getTmnById(id) {\r\n\tif (!id) return null;\r\n\t!CACHE.list && getTmns();\r\n\treturn CACHE.map[id];\r\n}\r\n\r\nexport function onTmnAddOrUpdate(tmn) {\r\n\tif (!CACHE.map || !tmn) return;\r\n\tlet old = CACHE.map[tmn.id];\r\n\tif (!old) {\r\n\t\tCACHE.map[tmn.id] = tmn;\r\n\t\tCACHE.list.push(tmn);\r\n\t} else {\r\n\t\tlet oldTmnKey = old.tmnKey;\r\n\t\tobjCopyTo(tmn, old);\r\n\r\n\t\t//终端标识发生变化，更新到关联的车辆上\r\n\t\tif (oldTmnKey == tmn.tmnKey || !tmn.carId) return;\r\n\t\tlet car = getCarById(tmn.carId);\r\n\t\tif (!car) return;\r\n\t\tif (car.tmnId == tmn.id) {//车辆主终端\r\n\t\t\tcar.tmnKey = tmn.tmnKey;\r\n\t\t} else if (car.viceKeys) {//车辆副终端  key1_v/a,key2_v/a,...\r\n\t\t\tlet keys = [];\r\n\t\t\tcar.viceKeys.split(',').forEach(key => key.indexOf(oldTmnKey+'_') == 0 && keys.push(tmn.tmnKey + '_' + key.split('_')[1]));\r\n\t\t\tcar.viceKeys = keys.length ? keys.join(',') : null;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport function onTmnDelete(tmnId) {\r\n\tif (!CACHE.list || !tmnId) return;\r\n\tlet tmn = CACHE.map[tmnId];\r\n\tdelete CACHE.map[tmnId];\r\n\tarrayRemoveValue(CACHE.list, 'id', tmnId);\r\n\r\n\t//解绑关联的车辆\r\n\tif (!tmn || !tmn.carId) return;\r\n\tlet car = getCarById(tmn.carId);\r\n\tif (!car) return;\r\n\tif (car.tmnId == tmnId) {//解绑车辆主终端\r\n\t\tcar.tmnId = car.tmnKey = null;\r\n\t} else if (car.viceKeys) {//解绑车辆副终端  key1_v/a,key2_v/a,...\r\n\t\tlet keys = [];\r\n\t\tcar.viceKeys.split(',').forEach(key => key.indexOf(tmn.tmnKey+'_') != 0 && keys.push(key));\r\n\t\tcar.viceKeys = keys.length ? keys.join(',') : null;\r\n\t}\r\n}\r\n\r\nexport function onTmnCarRecycle(car) {\r\n\tif (!CACHE.map || !car) return;\r\n\tif (car.tmnId) {\r\n\t\tlet tmn = CACHE.map[car.tmnId];\r\n\t\ttmn && (tmn.carId = null);\r\n\t}\r\n\tif (car.viceKeys) {\r\n\t\tcar.viceKeys.split(',').forEach(key => {\r\n\t\t\tlet tmn = getTmnByKey(key.split('_')[0]);\r\n\t\t\ttmn && (tmn.carId = null);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport function onTmnUnbindCar(tmnIds) {\r\n\tif (!CACHE.map || !tmnIds || tmnIds.length == 0) return;\r\n\ttmnIds.forEach(tmnId => {\r\n\t\tlet tmn = tmnId ? CACHE.map[tmnId] : null;\r\n\t\ttmn && (tmn.carId = null);\r\n\t});\r\n}\r\n"]}]}